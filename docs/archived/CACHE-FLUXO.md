# ğŸ”„ Diagrama de Fluxo: Cache PerpÃ©tuo

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    REQUISIÃ‡ÃƒO (GET /printers ou Kafka)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Existe cache Redis?   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                         â”‚
               NÃƒO                       SIM
                â”‚                         â”‚
                â–¼                         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  CACHE MISS (1Âª vez)  â”‚   â”‚  Calcular idade cache â”‚
    â”‚  âŒ Cache vazio       â”‚   â”‚  age = now - lastUpd  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                            â”‚
                â”‚                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                 â”‚                     â”‚
                â”‚            age < 5min            age > 5min
                â”‚            (FRESCO)              (STALE)
                â”‚                 â”‚                     â”‚
                â”‚                 â–¼                     â–¼
                â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚     â”‚  Cache HIT       â”‚   â”‚  Cache HIT (stale) â”‚
                â”‚     â”‚  âœ… Retorna      â”‚   â”‚  âœ… Retorna cache  â”‚
                â”‚     â”‚     imediatamente â”‚   â”‚  âš ï¸ Mas atualiza   â”‚
                â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚     em background  â”‚
                â”‚                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                                     â”‚
                â”‚                                     â–¼
                â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                         â”‚ isRefreshing?      â”‚
                â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                                  â”‚
                â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                         â”‚                 â”‚
                â”‚                        NÃƒO               SIM
                â”‚                         â”‚                 â”‚
                â”‚                         â–¼                 â–¼
                â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚              â”‚ Inicia refresh   â”‚  â”‚ Ignora       â”‚
                â”‚              â”‚ em background    â”‚  â”‚ (jÃ¡ rodando) â”‚
                â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                       â”‚
                â–¼                       â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         Buscar do SMB (smbclient)         â”‚
    â”‚    (Bloqueia sÃ³ se cache totalmente vazio)â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  Salvar no Redis      â”‚
            â”‚  â€¢ printers[]         â”‚
            â”‚  â€¢ lastUpdated: now   â”‚
            â”‚  â€¢ TTL: 30 dias       â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  ğŸ“¦ Cache atualizado  â”‚
            â”‚  âœ… Resposta enviada  â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š CenÃ¡rios Detalhados

### **CenÃ¡rio 1: Primeira RequisiÃ§Ã£o (Cache Vazio)**

```
Cliente         API                Redis              SMB
  â”‚              â”‚                   â”‚                 â”‚
  â”‚â”€GET /printersâ”€â–º                  â”‚                 â”‚
  â”‚              â”‚â”€â”€Existe cache?â”€â”€â”€â–ºâ”‚                 â”‚
  â”‚              â”‚â—„â”€â”€â”€â”€â”€NÃƒOâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚
  â”‚              â”‚                   â”‚                 â”‚
  â”‚              â”‚â”€â”€List printersâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  â”‚
  â”‚              â”‚â—„â”€â”€â”€â”€45 impressorasâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
  â”‚              â”‚                   â”‚                 â”‚
  â”‚              â”‚â”€â”€SETEX (30d)â”€â”€â”€â”€â”€â–ºâ”‚                 â”‚
  â”‚              â”‚â—„â”€â”€â”€â”€â”€OKâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚
  â”‚              â”‚                   â”‚                 â”‚
  â”‚â—„â”€45 impressoras                  â”‚                 â”‚
  â”‚              â”‚                   â”‚                 â”‚
  
Tempo: ~2000ms (busca SMB)
Log: âŒ Cache MISS - Buscando impressoras do SMB
```

---

### **CenÃ¡rio 2: Cache Fresco (<5min)**

```
Cliente         API                Redis              SMB
  â”‚              â”‚                   â”‚                 â”‚
  â”‚â”€GET /printersâ”€â–º                  â”‚                 â”‚
  â”‚              â”‚â”€â”€GET cacheâ”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                 â”‚
  â”‚              â”‚â—„â”€{printers, ts}â”€â”€â”€â”‚                 â”‚
  â”‚              â”‚                   â”‚                 â”‚
  â”‚              â”‚ (age = 120s < 300s)                 â”‚
  â”‚              â”‚ âœ… FRESH!          â”‚                 â”‚
  â”‚              â”‚                   â”‚                 â”‚
  â”‚â—„â”€45 impressoras                  â”‚                 â”‚
  â”‚              â”‚                   â”‚                 â”‚

Tempo: ~2ms (Redis)
Log: âœ… Cache HIT - Retornando impressoras do Redis
```

---

### **CenÃ¡rio 3: Cache Stale (>5min)**

```
Cliente         API                Redis              SMB
  â”‚              â”‚                   â”‚                 â”‚
  â”‚â”€GET /printersâ”€â–º                  â”‚                 â”‚
  â”‚              â”‚â”€â”€GET cacheâ”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                 â”‚
  â”‚              â”‚â—„â”€{printers, ts}â”€â”€â”€â”‚                 â”‚
  â”‚              â”‚                   â”‚                 â”‚
  â”‚              â”‚ (age = 400s > 300s)                 â”‚
  â”‚              â”‚ âš ï¸ STALE!          â”‚                 â”‚
  â”‚              â”‚                   â”‚                 â”‚
  â”‚â—„â”€45 impressoras (cache antigo)   â”‚                 â”‚
  â”‚              â”‚                   â”‚                 â”‚
  â”‚              â”‚â”€â”€â”€â”€â”€BACKGROUNDâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚
  â”‚              â”‚                   â”‚  List printers  â”‚
  â”‚              â”‚â—„â”€â”€â”€â”€45 impressoras (atualizado)â”€â”€â”€â”€ â”‚
  â”‚              â”‚                   â”‚                 â”‚
  â”‚              â”‚â”€â”€SETEX (30d)â”€â”€â”€â”€â”€â–ºâ”‚                 â”‚
  â”‚              â”‚â—„â”€â”€â”€â”€â”€OKâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚

Tempo resposta: ~2ms (nÃ£o espera SMB!)
Tempo total: ~2000ms (atualiza depois)
Log: âš ï¸ Cache stale (400s old) - Atualizando em background...
```

---

### **CenÃ¡rio 4: Kafka Print com Cache Stale**

```
Kafka           API                Redis              SMB       Impressora
  â”‚              â”‚                   â”‚                 â”‚             â”‚
  â”‚â”€print jobâ”€â”€â”€â”€â–ºâ”‚                  â”‚                 â”‚             â”‚
  â”‚              â”‚â”€â”€GET cacheâ”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                 â”‚             â”‚
  â”‚              â”‚â—„â”€{printers, ts}â”€â”€â”€â”‚                 â”‚             â”‚
  â”‚              â”‚                   â”‚                 â”‚             â”‚
  â”‚              â”‚ (age = 500s > 300s)                 â”‚             â”‚
  â”‚              â”‚ âš ï¸ STALE!          â”‚                 â”‚             â”‚
  â”‚              â”‚                   â”‚                 â”‚             â”‚
  â”‚              â”‚ âœ… USA CACHE ANTIGO!                â”‚             â”‚
  â”‚              â”‚                   â”‚                 â”‚             â”‚
  â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€DRY_RUNâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  â”‚
  â”‚              â”‚                   â”‚                 â”‚ (simulado)  â”‚
  â”‚â—„â”€successâ”€â”€â”€â”€â”€â”‚                   â”‚                 â”‚             â”‚
  â”‚              â”‚                   â”‚                 â”‚             â”‚
  â”‚              â”‚â”€â”€â”€â”€â”€BACKGROUNDâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚             â”‚
  â”‚              â”‚     (atualiza depois)               â”‚             â”‚

Tempo: ~300ms (DRY_RUN) ou ~1500ms (real)
Resultado: âœ… SEMPRE FUNCIONA! Nunca erro 500!
```

---

## ğŸ¯ Comportamento por Idade

```
Idade do Cache          Comportamento                     Logs
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
0-5min (fresco)        âœ… Retorna cache                  âœ… Cache HIT
                       â¸ï¸ NÃ£o atualiza
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
5min-30dias (stale)    âœ… Retorna cache antigo           âš ï¸ Cache stale
                       ğŸ”„ Atualiza em background         ğŸ“¦ Cache atualizado
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
>30 dias (expirado)    âœ… Busca do SMB (bloqueia)        âŒ Cache MISS
                       ğŸ“¦ Salva no Redis                 ğŸ“¦ Cache atualizado
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

---

## ğŸ”’ ProteÃ§Ã£o contra Refresh Duplicado

```
Request 1                     Request 2                     Request 3
    â”‚                             â”‚                             â”‚
    â”‚â”€â”€Cache stale (400s)         â”‚                             â”‚
    â”‚â”€â”€isRefreshing = false       â”‚                             â”‚
    â”‚â”€â”€âœ… Inicia refresh           â”‚                             â”‚
    â”‚  isRefreshing = true         â”‚                             â”‚
    â”‚                             â”‚â”€â”€Cache stale (401s)         â”‚
    â”‚                             â”‚â”€â”€isRefreshing = true        â”‚
    â”‚                             â”‚â”€â”€âŒ Ignora (jÃ¡ rodando)      â”‚
    â”‚                             â”‚                             â”‚
    â”‚                             â”‚                             â”‚â”€â”€Cache stale (402s)
    â”‚                             â”‚                             â”‚â”€â”€isRefreshing = true
    â”‚                             â”‚                             â”‚â”€â”€âŒ Ignora
    â”‚                             â”‚                             â”‚
    â”‚â”€â”€SMB response (2000ms)      â”‚                             â”‚
    â”‚â”€â”€Save to Redis              â”‚                             â”‚
    â”‚â”€â”€isRefreshing = false       â”‚                             â”‚
    â”‚  âœ… PrÃ³ximo pode atualizar   â”‚                             â”‚
```

---

## ğŸ“ˆ MÃ©tricas de Performance

| OperaÃ§Ã£o | Tempo | Bloqueia? |
|----------|-------|-----------|
| Cache HIT (fresco) | ~2ms | NÃ£o |
| Cache HIT (stale) | ~2ms | NÃ£o |
| Background refresh | ~2000ms | NÃ£o |
| Cache MISS (1Âª vez) | ~2000ms | **Sim** |

**Resultado:** 99.9% das requisiÃ§Ãµes sÃ£o instantÃ¢neas! âš¡

---

**ğŸ‰ Sistema otimizado para alta disponibilidade e performance!**
